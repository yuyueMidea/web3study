## `web3.0`的应用架构

`web3.0`的架构与`web2.0`应用程序完全不同；

以一个简单的博客网站 `Medium`举例；`Medium` 允许用户发布自己的内容，并与他人的内容进行交互。当你在`Medium`上写博客时，你与它的前端互动，前端和后端交互，后端再与它的数据库交互，所有这些代码都托管在中心化服务器上，并通过互联网浏览器发送给用户。这是对当今大多数`web2.0`应用程序的工作原理的高度总结。

与`Medium`这类web2.0 不同的是，web3.0 去除了中间层，这中间没有存储应用程序状态的中心化数据库，也没有中心化网站服务器用于存储后端逻辑。

你可以利用区块链构建应用程序，在去中心化的状态机 构建应用程序，这一系统由互联网上的匿名节点在维护。

状态机是指一种可维持程序状态的 并允许新状态写入的[机器]，区块链就是一种虚拟机；没有单一实体控制这个去中心化的状态机，它由网络中的每个人共同维护。


## 深度解析

1、区块链，以太坊是全球都可以参与维护的，点对点具有确定性的状态机，状态机上的状态更改由网络中的 遵循共识机制的节点 控制。 数据只能写入以太坊区块链，你永远无法更新现有数据。

2、智能合约，是运行在以太坊区块链上的程序，用于定义区块链上 发生的状态变化 背后的逻辑；智能合约通常由Solidity或Vyper 这类高级语言编写。

3、以太坊虚拟机（EVM），虚拟机是用来执行智能合约中定义的逻辑 并处理状态机上发生的状态变化。以太坊虚拟机不理解Solidity或Vyper这类高级语言，需要给Solidity编译成虚拟机可以执行的字节码。

## 以太坊上前端代码如何与智能合约进行交互

当我们想和区块链上的数据和代码进行交互的时候，就要与区块链中的某一个节点进行通信；因为任何节点都可以广播在以太坊虚拟机上进行交易的请求，在这之后矿工将执行交易并将结果状态更改广播到网络的其他节点上。

有两种方式广播新的交易：

1、自己设立一个运行以太坊程序的节点；

2、使用 infura 或者 Alchemy 第三方提供的节点；

使用第三方节点，能让你免去自己运行全节点所带来的麻烦；因为有大量数据需要同步，设立一个以太坊的节点通常需要好几天的时间。此外，存储完整以太坊区块链的成本随着DApp的扩容而增加，你需要添加更多节点来扩张你的基础设施；综上所述，为了避免这些麻烦，许多DApp选择使用Infura或 Alchemy之类的服务商来管理他们的节点，这些节点通常被称为【提供商（Providers）】。

每个以太坊客户端（提供者）实行JSON-RPC规范，这确保了前端应用程序想要与区块链交互时 有一组统一的方法；JSON-RPC是一种、轻量级的远程应用程式调用协议，它定义了多个数据结构及其处理规则。它具有传输不可知性，这些概念可在同一进程中被使用、穿梭在sockets、http或许多不同的消息传递环境中，它使用JSON（RFC4627）作为数据格式。

当你通过提供商连接到区块链后，就可以读取存储在区块链上的状态；但是 如果想要写入状态，需要在交易提交到区块链之前，使用你的私钥 对交易进行签名。

举例 当用户想要在区块链上发布新的文章时，DApp会要求用户使用他们的私钥[签署]交易，只有这样DApp才会将交易传播到区块链上，负责节点不会接受这笔交易。

签署交易这个环节通常使用到Metamask，Metamask是一种工具，可以让应用程序轻松处理密钥管理和交易签名；Metamask将用户的私钥存储在浏览器中，每当前端需要用户签署交易时，它都会调用Metamask。

**在区块链上存储**

在区块链上存储，虽然快捷，但价格不菲；用户每次在以太坊添加新数据都要付费，这是因为去中心化的状态机是由节点来维护的，而状态机上每新增一个状态，都会增加节点的成本。

使用去中心化链下存储方案，如IPFS或Swarm，可以免去支付费用的麻烦。

IPFS是一个用于存储与访问数据的分布式文件系统；也就是说IPFS系统并不是将数据存储在一个中心化的数据库中，而是将数据分布式存储在P2P网络中，让你随时可以对数据进行检索。[Filecoin]是IPFS的激励层，其作用是激励世界各地的节点来存储和检索这些数据，可以使用像Infura或Pinata这样的提供商，Infura可以为你提供IPFS节点，而Pinata则可以让你将文件在IPFS中定位，继而得到IPFS的哈希值 并将其存储到区块链上，整个过程简单。

Swarm是一个去中心化的存储网络，和IPFS有许多相似之处，差别在于：`Filecoin`系统相对独立，Swarm的激励系统是内置的，由以太坊上的智能合约来执行，用于数据的存储和检索。

如果想要搭建一个真正的去中心化的应用程序，就要选择IPFS或Swarm这样的去中心化存储方案来存储前端了。

**在区块链上进行查询**

从区块链上的智能合约中读取数据又该如何操作呢，查询主要有两种方式：

1、智能合约事件：可以利用ethers.js库来查询和监听智能合约事件，可以使用ethers.js监听特定事件，并指定一个回调函数在每次事件触发时进行调用，前端代码可以监听由智能合约所触发的事件并采取相应的行动；

2、The Graph，是一个链下数据索引方案，可以方便在以太坊上查询数据；在The Graph中，你既可以定义哪些智能合约需要索引、哪些事件与函数调用需要监听，也可以规定如何将传入的事件转化为前端逻辑可处理的实体；它使用GraphQL 作为查询语言，对比传统的REST API，它能传递更多的信息。通过索引区块链数据，The Graph可以让我们在应用逻辑中查询链上数据，并且几乎不会出现延迟的情况。



